---
title: "Tracking Negative Emissions"
author: "Natanel Ha"
date: "8/4/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: 
     collapsed: false
     smooth_scroll: true
    theme: paper
---

This document reflects done the work done by Natanel Ha on tracking negative
emissions scenarios (constructed with Jay Fuhrman's data) using the simple
climate model Hector's tracking feature. 

### Importing Libraries 
```{r importing, message=FALSE, warning=FALSE, class.source = 'fold-show'}
library(hector)
library(ggplot2)
library(dplyr)
library(tidyr)
```

### Establishing INI files
In all the INI files, the year tracking starts is 2020. I chose this year
because in all the scenarios DACCS starts in 2021, and 2020 seemed 
like a reasonable baseline. 

I chose 4 our of the 8 scenarios to focus on. SSP1 was chosen as a baseline 
run, and SSP5 had the most negative emissions through DACCS so I chose those 
two.
```{r inifiles, message=FALSE, warning=FALSE, class.source = 'fold-show'}
path <- "/Users/Natanel Ha/Documents/GitHub/Ha-Hector-Internship/New Scenarios/"
ini_file_26_SSP1 <- paste(path, "jay_SSP1.ini", sep = "")
ini_file_19_SSP1 <- paste(path, "jay_19_SSP1.ini", sep = "")
ini_file_26_SSP5 <- paste(path, "jay_SSP5.ini", sep = "")
ini_file_19_SSP5 <- paste(path, "jay_19_SSP5.ini", sep = "")
```


## Basic Tracking Plots
Creating basic plots that display the tracking results, in terms of the
fraction of carbon that originated in each pool and the amount of carbon
that originated in each pool. 

First, I created a function to get tracking results
```{r basicTrackingFunction}
tracking_results <- function(ini_file, start, stop, scenarioName) {
  # establish core
  core <- newcore(ini_file)

  # run core
  run(core)

  # Get Results
  results_with_diff <- get_tracking_data(core)
  results_with_diff

  # Filter out diff and year
  td <-
    results_with_diff %>%
    filter(pool_name != "Diff") %>%
    filter(year <= stop) %>%
    filter(year >= start) %>%
    mutate(source_amount = source_fraction * pool_value) %>%
    mutate(scenario = scenarioName)

  return(td)
}
```

Then I created a function that would return a simple tracking plot. It would
either return it with the y axis being the source fraction source amount. 
It also has the option to focus on a pool if you specify.
```{r basicTrackingPlot}
basic_plot <- function(td, graph_type, pool, title){
  # Changing Order
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))
  
  # Set Theme
  theme_set(theme_minimal())
  
  # Filter for Pool
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
      td
  }
  
  ylabel <- "" 
  
  # Graph of Fractional Portion
  if (graph_type == "fraction") {
    td %>%
      rename(yval = source_fraction) ->
      td
    ylabel <- "Source Fraction"
  }
  else {
    td %>%
      rename(yval = source_amount) ->
      td
    ylabel <- "Source Amount (Pg C)"
  }
    areaGraph <- ggplot(td) +
      aes(x = year, y = yval, fill = source_name) +
      geom_area() +
      facet_wrap(~pool_namef, scales = "free_y",
                 labeller = labeller(pool_namef = c(
                   "detritus_c_global" = "Detritus",
                   "veg_c_global" = "Vegetation",
                   "soil_c_global" = "Soil",
                   "earth_c" = "Earth",
                   "atmos_c" = "Atmosphere",
                   "HL" = "High Level Ocean",
                   "intermediate" = "Intermediate Ocean",
                   "LL" = "Low Level Ocean",
                   "deep" = "Deep Ocean"
                 ))
      ) +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
      ) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab(ylabel) +
      ggtitle(title) +
      xlab("Year")
  return(areaGraph)
}
```

Then I combined the two into one function for easier and efficient use
```{r combinedBasicFucntion}
# tracking plot function
tracking_plot <- function(ini_file, start, stop, graph_type, pool, scenario) {
  td <- tracking_results(ini_file, start, stop, scenario)
  graph <- basic_plot(td, graph_type, pool, scenario)
  return(graph)
}
```

### Basic Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r frac26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r frac26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r frac19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r frac19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP5"
)
```

### Basic Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r am26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP1"
)
```

#### RCP 2.6 SSP5
```{r am26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r am19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r am19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP5"
)
```


## Earth Pool Examination 
In order to see where the Negative Emissions were being pulled from, I examined
the Earth Pool in further detail. Since the Earth pool was so large and it was 
hard to see what other pools were inside it, I decided to look at net
change from 2020. 

First I created a function that calculated net change in earth pool from 2020
```{r earthFunc}
earth_calc <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario) %>%
    filter(pool_name == "earth_c")

  # Finding earth_c values in start
  # The year negative emissions starts
  earth_start <-
    results %>%
    filter(source_name == "earth_c")

  earth_start_carbon <-
    first(earth_start$source_amount)

  earth_start_fraction <-
    first(earth_start$source_fraction)

  # Calculating difference from start
  results %>%
    mutate(source_amount = source_amount - earth_start_carbon * (source_name == "earth_c")) %>%
    mutate(source_fraction = source_fraction - earth_start_fraction * 
             (source_name =="earth_c")) ->
  results
  return(results)
}

```

Then I created a function to create a simple area graph. It allows for both
a y axis of the source fraction and source amount of carbon. 
```{r earthPlotFunction}
earth_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }

  return(areaGraph)
}
```

For ease and efficiency, I made a function to run both of th previous
functions. 
```{r combinedEarthFunc, message=FALSE, warning=FALSE}
earth_plot <- function(ini_file, start, stop, type, scenario) {
  results <- earth_calc(ini_file, start, stop, scenario)
  plot <- earth_plot_maker(results, start, type, scenario, FALSE)
  return(plot)
}
```

For use in faceting, I combined several pathways into one big data. 
```{r combingEarth, message=FALSE, warning=FALSE}
total_results <-
  rbind(
    earth_calc(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    earth_calc(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    earth_calc(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    earth_calc(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

### Earth Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r earth_frac26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_frac26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_frac19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_frac19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r earth_Fracfaceted, echo=FALSE}
earth_plot_maker(
  total_results, 2020, "fraction", "NA", TRUE
)
```

### Earth Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r earth_am26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_am26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_am19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_am19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r earth_amfaceted, echo=FALSE}
earth_plot_maker(
  total_results, 2020, "amount", "NA", TRUE
)
```

### Stacked Bar Chart
I also made stacked bar charts from the combine dataset 

First I had to filter the results
```{r barFilter}
total_results %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barResults
```

Then it could be plotted.

#### Graphs {.tabset}
##### Amount of Carbon
```{r stackedAmount, fig.width=9}
amountBar <- ggplot(barResults)+
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

##### Fraction of Pool
```{r stackedFraction, fig.width=9}
fracBar <- ggplot(barResults) +
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
fracBar
```

## Split Earth Pool
Splitting Earth pool with fossil fuel emissions to take account for the 
earth pool going in vs the earth pool going out

First I created a function to make the calucation to split it between output
and input
```{r ffi}
ffi_results <- function(ini_file, start, stop, scenario) {
  results <- earth_calc(ini_file, start, stop, scenario)
  
  core <- newcore(ini_file)
  run(core)
  
  ffi_emissions <- fetchvars(core, 2020:2100, FFI_EMISSIONS())
  ffi_emissions$value <- cumsum(ffi_emissions$value)

  ffi_emissions %>%
    select(value, year) %>%
    rename("fossil_fuels" = value) ->
  ffi_emissions

  results %>%
    right_join(ffi_emissions) %>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount") %>%
    mutate(earth_c = earth_c + fossil_fuels) %>%
    mutate(fossil_fuels = fossil_fuels * -1) %>%
    pivot_longer(5:14, names_to = "source_name", values_to = "source_amount") ->
  results
}
```

Then I made a new combined function, to account for the new calculation
```{r ffiCombined}
split_earth <- function(ini_file, start, stop, scenario) {
  results <- ffi_results(ini_file, start, stop, scenario)
  plot <- earth_plot_maker(results, start, "amount", scenario, FALSE)
  return(plot)
}
```

I also created a new combined dataset for faceting. 
```{r combiningFfi, message=FALSE, warning=FALSE}
total_results_split <-
  rbind(
    ffi_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    ffi_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    ffi_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    ffi_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

In the earth plot maker function, I also changed the labeller to include fossil 
fuel emissions, and the coloring. Here is that changed snippet:
```{r changeInFfiGraph, eval=FALSE, message=FALSE, warning=FALSE, results='hide'}
scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "fossil_fuels",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth In",
        "Earth Out",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#882255",
        "#DDDDDD"
      )

```

```{r changedEarthPlot, include=FALSE}
earth_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""
  
  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
      results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
      results
    ylabel <- "Source Amount (Pg C)"
  }
  
  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "fossil_fuels",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth In",
        "Earth Out",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#882255",
        "#DDDDDD"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")
  
  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start),
              subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  
  return(areaGraph)
}
```

### Split Earth Plots {.tabset}
#### RCP 2.6 SSP1
```{r earth_split26s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP6
```{r earth_split26s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earth_split19s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earth_split19s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

#### Facetted
```{r earth_split_facetted, echo=FALSE, message=FALSE, warning=FALSE}
earth_plot_maker(total_results_split, 2020, "amount", "NA", TRUE)
```

### Stacked Bar Chart
I also made stacked bar charts from the combine dataset 

First we needed to filter for years
```{r filterEarthYears}
total_results_split %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

Then it could be plotted. 
```{r earthStackedBar, fig.width=9}
barGraph <- ggplot(barData) +
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "fossil_fuels",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth In",
      "Earth Out",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#882255",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
barGraph
```

## Function for increase in each pool
For further examination of the tracking, I decided to look at the rates 
at which each of the pools were changing. I calculated this by looking
at the increase or decrease from the previous year

First I made a fucntion to calcualte the value
```{r diffFunc}
# Tracking plot Function
difference_calc <- function(ini_file, start, stop, title) {
  td <- tracking_results(ini_file, start, stop, title)
  
  td %>%
    group_by(pool_name, source_name) %>%
    mutate(differ = source_amount - lag(source_amount)) ->
  td
  
  # Filtering out years and NA
  td %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    filter(!is.na(differ)) %>%
    filter(differ != 0)->
    td
}
```

Then I created a function to create a plot that displays this difference 
in an area graph. 
```{r diffPlotMaker}
difference_plot_maker <- function(td, pool, title, facet) {
  # Creating better labels
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))

  # A plot of all pools
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
    lineSize <- 1.75
  }
  else {
    lineSize <- 1
  }
  
  lineGraph <- ggplot(td) +
    aes(x = year, y = differ, color = source_name) +
    geom_line(size = lineSize) +
    facet_wrap(~pool_namef,
      scales = "free_y",
      labeller = labeller(pool_namef = c(
        "detritus_c_global" = "Detritus",
        "veg_c_global" = "Vegetation",
        "soil_c_global" = "Soil",
        "earth_c" = "Earth",
        "atmos_c" = "Atmosphere",
        "HL" = "High Level Ocean",
        "intermediate" = "Intermediate Ocean",
        "LL" = "Low Level Ocean",
        "deep" = "Deep Ocean"
      ))
    ) +
    scale_color_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c",
        "HL",
        "intermediate",
        "LL",
        "deep"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere",
        "High Level Ocean",
        "Intermediate Ocean",
        "Low Level Ocean",
        "Deep Ocean"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD",
        "#882255",
        "#AA4499",
        "#88CCEE",
        "#332288"
      )
    ) +
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab("Change from Previous Year (Pg C/Yr)") +
    xlab("Year")
  
  if (facet == FALSE) {
    lineGraph <- lineGraph +
      ggtitle(title)
  } else {
    lineGraph <- lineGraph  +
      facet_wrap(~scenario)
  }
  return(lineGraph)
}
```

I also created a function that combines the previous two into one for ease of use
```{r diffCombinedFunc}
difference_plot <- function(ini_file, start, stop, pool, title){
  td <- difference_calc(ini_file, start, stop, title)
  graph <- difference_plot_maker(td, pool, title, FALSE)
  return(graph)
}
```

I combined all the scenarios into one dataset for faceting
```{r diffCombined}
total_results <-
  rbind(
    difference_calc(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    difference_calc(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    difference_calc(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    difference_calc(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

### Difference Plots {.tabset}
#### RCP 2.6 SSP1
```{r dif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "all", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r dif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "all", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r dif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "all", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r dif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "all", "RCP 1.9 SSP5")
```

```{r hiddenDiffChange, message=FALSE, warning=FALSE, include=FALSE}
difference_plot_maker <- function(td, pool, title, facet) {
  # Creating better labels
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))

  # A plot of all pools
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
    lineSize <- 1.25
  }
  else {
    lineSize <- 0.75
  }
  
  lineGraph <- ggplot(td) +
    aes(x = year, y = differ, color = source_name) +
    geom_line(size = lineSize) +
    facet_wrap(~pool_namef,
      scales = "free_y",
      labeller = labeller(pool_namef = c(
        "detritus_c_global" = "Detritus",
        "veg_c_global" = "Vegetation",
        "soil_c_global" = "Soil",
        "earth_c" = "Earth",
        "atmos_c" = "Atmosphere",
        "HL" = "High Level Ocean",
        "intermediate" = "Intermediate Ocean",
        "LL" = "Low Level Ocean",
        "deep" = "Deep Ocean"
      ))
    ) +
    scale_color_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD"
      )
    ) +
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab("Change from Previous Year (Pg C/Yr)") +
    xlab("Year")
  
  if (facet == FALSE) {
    lineGraph <- lineGraph +
      ggtitle(title)
  } else {
    lineGraph <- lineGraph  +
      facet_wrap(~scenario)
  }
  return(lineGraph)
}
```

### Difference in Earth Pool {.tabset}
#### RCP 2.6 SSP1
```{r earthDif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "earth_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earthDif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "earth_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earthDif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "earth_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earthDif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "earth_c", "RCP 1.9 SSP5")
```

#### Faceted
```{r earthDifFacet}
difference_plot_maker(total_results, "earth_c", "NA", TRUE)
```

### Difference in Atmospheric Pool {.tabset}
#### RCP 2.6 SSP1
```{r atmosDif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "atmos_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r atmosDif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "atmos_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r atmosDif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "atmos_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r atmosDif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "atmos_c", "RCP 1.9 SSP5")
```

#### Faceted
```{r atmosDifFacet}
difference_plot_maker(total_results, "atmos_c", "NA", TRUE)
```

## Atmopsheric Pool Examination
I then took a deeper look at the atmosphere pool. I took a similar approach as the earth
pool and made a function that would look at net change from 2020. 

```{r atmosFunc}
atmos_results <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario)

  results %>%
    filter(pool_name == "atmos_c") %>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount") %>%
    mutate(detritus_c_global = detritus_c_global - first(detritus_c_global))%>%
    mutate(veg_c_global = veg_c_global - first(veg_c_global))%>%
    mutate(soil_c_global = soil_c_global - first(soil_c_global))%>%
    mutate(earth_c = earth_c - first(earth_c))%>%
    mutate(atmos_c = atmos_c - first(atmos_c))%>%
    pivot_longer(5:13, names_to = "source_name", values_to = "source_amount") ->
    results
  return(results)
}
```

I also created a function that would also split the atmosphere with the earth pool
```{r splitAtmosFunc}
atmos_results_split <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario)
  
  core <- newcore(ini_file)
  run(core)
  
  ffi_emissions <- fetchvars(core, 2020:2100, FFI_EMISSIONS())
  ffi_emissions$value <- cumsum(ffi_emissions$value)
  
  ffi_emissions %>%
    select(value, year) %>%
    rename("fossil_fuels" = value) ->
    ffi_emissions
  
  results %>%
    filter(pool_name == "atmos_c") %>%
    right_join(ffi_emissions) %>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount") %>%
    mutate(earth_c = earth_c - fossil_fuels) %>%
    mutate(detritus_c_global = detritus_c_global - first(detritus_c_global))%>%
    mutate(veg_c_global = veg_c_global - first(veg_c_global))%>%
    mutate(soil_c_global = soil_c_global - first(soil_c_global))%>%
    mutate(earth_c = earth_c - first(earth_c))%>%
    mutate(atmos_c = atmos_c - first(atmos_c))%>%
    pivot_longer(5:14, names_to = "source_name", values_to = "source_amount") ->
    results
  return(results)
}
```

I then also created a plotting function
```{r atmosPlotFunc}
atmos_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  return(areaGraph)
}
```

I then created combined functions for both the unsplit and split atmospheric 
pools
```{r combinedAtmosFunc}
#Unsplit
atmos_plot <- function(ini_file, start, stop, type, scenario) {
  results <- atmos_results(ini_file, start, stop, scenario)
  plot <- atmos_plot_maker(results, start, type, scenario, FALSE)
  return(plot)
}

#Split
atmos_plot_split <- function(ini_file, start, stop, scenario) {
  results <- atmos_results_split(ini_file, start, stop, scenario)
  plot <- atmos_plot_maker(results, start, "amount", scenario, FALSE)
  return(plot)
}
```

I then created larger combined datasets for faceting
```{r facetDataAtmos, message=FALSE, warning=FALSE}
#Unsplit
atmos_combined <- rbind(
  atmos_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
  atmos_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
  atmos_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
  atmos_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
)

#Split
atmos_combined_split <- rbind(
  atmos_results_split(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
  atmos_results_split(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
  atmos_results_split(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
  atmos_results_split(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
)
```

### Atmospheric Plots {.tabset}

#### RCP 2.6 SSP1
```{r atm_am26s1, echo=FALSE}
atmos_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r atm_am26s5, echo=FALSE}
atmos_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r atm_am19s1, echo=FALSE}
atmos_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r atm_am19s5, echo=FALSE}
atmos_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r atm_amfaceted, echo=FALSE}
atmos_plot_maker(
  atmos_combined, 2020, "amount", "NA", TRUE
)
```

### Stacked Bar Graphs {.tabset}

First we needed to filter for years
```{r filteratmYears}
atmos_combined %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

#### Graphs {.tabset}
##### Amount of Carbon
```{r atm_stackedAmount, fig.width=9}
amountBar <- ggplot(barData)+
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

##### Fraction of Pool
```{r atm_stackedFraction, fig.width=9}
fracBar <- ggplot(barResults) +
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
fracBar
```

```{r atmosPlotFuncHidden, include=FALSE}
atmos_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "fossil_fuels",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth In",
      "Earth Out",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#882255",
      "#DDDDDD"
    )
  ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  return(areaGraph)
}
```

### Atmospheric Pool with Split Earth {.tabset}
#### RCP 2.6 SSP1
```{r atm_split26s1, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP6
```{r atm_split26s5, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r atm_split19s1, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r atm_split19s5, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

#### Facetted
```{r atm_split_facetted, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_maker(atmos_combined_split, 2020, "amount", "NA", TRUE)
```

### Stacked Bar Graph with Split Earth
I also made stacked bar charts from the combine dataset 

First we needed to filter for years
```{r filteratmYearsSplit}
atmos_combined_split %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

Then it could be plotted. 
```{r atmStackedBar, fig.width=9}
barGraph <- ggplot(barData) +
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "fossil_fuels",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Fossil Fuels",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#882255",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
barGraph
```

##### Session Info: 
```{r sessionInfo, echo=FALSE}
sessionInfo()
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>

