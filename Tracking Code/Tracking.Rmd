---
title: "Tracking Negative Emissions"
author: "Natanel Ha"
date: "8/4/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: 
     collapsed: false
     smooth_scroll: true
    theme: paper
---

This document reflects done the work done by Natanel Ha on tracking negative
emissions scenarios (constructed with Jay Fuhrman's data) using the simple
climate model Hector's tracking feature. 

### Importing Libraries 
```{r importing, message=FALSE, warning=FALSE, class.source = 'fold-show'}
library(hector)
library(ggplot2)
library(dplyr)
library(tidyr)
```

### Establishing INI files
In all the INI files, the year tracking starts is 2020. I chose this year
because in all the scenarios DACCS starts in 2021, and 2020 seemed 
like a reasonable baseline. 

I chose 4 our of the 8 scenarios to focus on. SSP1 was chosen as a baseline 
run, and SSP5 had the most negative emissions through DACCS so I chose those 
two.
```{r inifiles, message=FALSE, warning=FALSE, class.source = 'fold-show'}
path <- "/Users/Natanel Ha/Documents/GitHub/Ha-Hector-Internship/New Scenarios/"
ini_file_26_SSP1 <- paste(path, "jay_SSP1.ini", sep = "")
ini_file_19_SSP1 <- paste(path, "jay_19_SSP1.ini", sep = "")
ini_file_26_SSP5 <- paste(path, "jay_SSP5.ini", sep = "")
ini_file_19_SSP5 <- paste(path, "jay_19_SSP5.ini", sep = "")
```


## Basic Tracking Plots
Creating basic plots that display the tracking results, in terms of the
fraction of carbon that originated in each pool and the amount of carbon
that originated in each pool. 

First, I created a function to get tracking results
```{r basicTrackingFunction}
tracking_results <- function(ini_file, start, stop, scenarioName) {
  # establish core
  core <- newcore(ini_file)

  # run core
  run(core)

  # Get Results
  results_with_diff <- get_tracking_data(core)
  results_with_diff

  # Filter out diff and year
  td <-
    results_with_diff %>%
    filter(pool_name != "Diff") %>%
    filter(year <= stop) %>%
    filter(year >= start) %>%
    mutate(source_amount = source_fraction * pool_value) %>%
    mutate(scenario = scenarioName)

  return(td)
}
```

Then I created a function that would return a simple tracking plot. It would
either return it with the y axis being the source fraction source amount. 
It also has the option to focus on a pool if you specify.
```{r basicTrackingPlot}
basic_plot <- function(td, graph_type, pool, title){
  # Changing Order
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))
  
  # Set Theme
  theme_set(theme_minimal())
  
  # Filter for Pool
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
      td
  }
  
  ylabel <- "" 
  
  # Graph of Fractional Portion
  if (graph_type == "fraction") {
    td %>%
      rename(yval = source_fraction) ->
      td
    ylabel <- "Source Fraction"
  }
  else {
    td %>%
      rename(yval = source_amount) ->
      td
    ylabel <- "Source Amount (Pg C)"
  }
    areaGraph <- ggplot(td) +
      aes(x = year, y = yval, fill = source_name) +
      geom_area() +
      facet_wrap(~pool_namef, scales = "free_y",
                 labeller = labeller(pool_namef = c(
                   "detritus_c_global" = "Detritus",
                   "veg_c_global" = "Vegetation",
                   "soil_c_global" = "Soil",
                   "earth_c" = "Earth",
                   "atmos_c" = "Atmosphere",
                   "HL" = "High Level Ocean",
                   "intermediate" = "Intermediate Ocean",
                   "LL" = "Low Level Ocean",
                   "deep" = "Deep Ocean"
                 ))
      ) +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
      ) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab(ylabel) +
      ggtitle(title) +
      xlab("Year")
  return(areaGraph)
}
```

Then I combined the two into one function for easier and efficient use
```{r combinedBasicFucntion}
# tracking plot function
tracking_plot <- function(ini_file, start, stop, graph_type, pool, scenario) {
  td <- tracking_results(ini_file, start, stop, scenario)
  graph <- basic_plot(td, graph_type, pool, scenario)
  return(graph)
}
```

### Basic Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r frac26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r frac26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r frac19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r frac19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP5"
)
```

### Basic Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r am26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP1"
)
```

#### RCP 2.6 SSP5
```{r am26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r am19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r am19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP5"
)
```


## Earth Pool Examination 
In order to see where the Negative Emissions were being pulled from, I examined
the Earth Pool in further detail. Since the Earth pool was so large and it was 
hard to see what other pools were inside it, I decided to look at net
change from 2020. 

First I created a function that calculated net change in earth pool from 2020
```{r earthFunc}
earth_calc <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario) %>%
    filter(pool_name == "earth_c")

  # Finding earth_c values in start
  # The year negative emissions starts
  earth_start <-
    results %>%
    filter(source_name == "earth_c")

  earth_start_carbon <-
    first(earth_start$source_amount)

  earth_start_fraction <-
    first(earth_start$source_fraction)

  # Calculating difference from start
  results %>%
    mutate(source_amount = source_amount - earth_start_carbon * (source_name == "earth_c")) %>%
    mutate(source_fraction = source_fraction - earth_start_fraction * 
             (source_name =="earth_c")) ->
  results
  return(results)
}

```

Then I created a function to create a simple area graph. It allows for both
a y axis of the source fraction and source amount of carbon. 
```{r earthPlotFunction}
earth_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }

  return(areaGraph)
}
```

For ease and efficiency, I made a function to run both of th previous
functions. 
```{r combinedEarthFunc, message=FALSE, warning=FALSE}
earth_plot <- function(ini_file, start, stop, type, scenario) {
  results <- earth_calc(ini_file, start, stop, scenario)
  plot <- earth_plot_maker(results, start, type, scenario, FALSE)
  return(plot)
}
```

For use in faceting, I combined several pathways into one big data. 
```{r combingEarth, message=FALSE, warning=FALSE}
total_results <-
  rbind(
    earth_calc(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    earth_calc(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    earth_calc(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    earth_calc(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

### Earth Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r earth_frac26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_frac26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_frac19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_frac19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r earth_Fracfaceted, echo=FALSE}
earth_plot_maker(
  total_results, 2020, "fraction", "NA", TRUE
)
```

### Earth Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r earth_am26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_am26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_am19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_am19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r earth_amfaceted, echo=FALSE}
earth_plot_maker(
  total_results, 2020, "amount", "NA", TRUE
)
```

### Stacked Bar Chart
I also made stacked bar charts from the combine dataset 

First I had to filter the results
```{r barFilter}
total_results %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barResults
```

Then it could be plotted.

#### Graphs {.tabset}
##### Amount of Carbon
```{r stackedAmount, fig.width=9}
amountBar <- ggplot(barResults)+
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  )+
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

##### Fraction of Pool
```{r stackedFraction, fig.width=9}
fracBar <- ggplot(barResults) +
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
fracBar
```

## Split Earth Pool
Splitting Earth pool with fossil fuel emissions to take account for the 
earth pool going in vs the earth pool going out

First I created a function to make the calucation to split it between output
and input
```{r ffi}
ffi_results <- function(ini_file, start, stop, scenario) {
  results <- earth_calc(ini_file, start, stop, scenario)
  
  core <- newcore(ini_file)
  run(core)
  
  daccs <- fetchvars(core, 2020:2100, DACCS_UPTAKE())
  daccs$value <- cumsum(daccs$value)

  daccs %>%
    select(value, year) %>%
    rename("daccs_uptake" = value) ->
  daccs
   
  results %>%
    group_by(year, scenario) %>%
    mutate(sum = sum(source_amount)) ->
  results
  
  results %>%
    right_join(daccs)%>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount")%>%
    mutate(fossil_fuels = earth_c)%>%
    mutate(earth_c = daccs_uptake - sum + earth_c)%>%
    mutate(fossil_fuels = fossil_fuels - earth_c)%>%
    select(-sum, -daccs_uptake)%>%
    pivot_longer(5:14, names_to = "source_name", values_to = "source_amount")->
  results
}
```

Then I made a new combined function, to account for the new calculation
```{r ffiCombined}
split_earth <- function(ini_file, start, stop, scenario) {
  results <- ffi_results(ini_file, start, stop, scenario)
  plot <- earth_plot_maker(results, start, "amount", scenario, FALSE)
  return(plot)
}
```

I also created a new combined dataset for faceting. 
```{r combiningFfi, message=FALSE, warning=FALSE}
total_results_split <-
  rbind(
    ffi_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    ffi_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    ffi_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    ffi_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

In the earth plot maker function, I also changed the labeller to include fossil 
fuel emissions, and the coloring. Here is that changed snippet:
```{r changeInFfiGraph, eval=FALSE, message=FALSE, warning=FALSE, results='hide'}
scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth In",
          "Earth Out",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )

```

```{r changedEarthPlot, include=FALSE}
earth_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""
  
  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
      results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
      results
    ylabel <- "Source Amount (Pg C)"
  }
  
  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth In",
          "Earth Out",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")
  
  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start),
              subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  
  return(areaGraph)
}
```

### Split Earth Plots {.tabset}
#### RCP 2.6 SSP1
```{r earth_split26s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earth_split26s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earth_split19s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earth_split19s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

#### Facetted
```{r earth_split_facetted, echo=FALSE, message=FALSE, warning=FALSE}
earth_plot_maker(total_results_split, 2020, "amount", "NA", TRUE)
```

### Stacked Bar Chart
I also made stacked bar charts from the combined dataset 

First we needed to filter for years
```{r filterEarthYears}
total_results_split %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

Then it could be plotted. 
```{r earthStackedBar, fig.width=9}
barGraph <- ggplot(barData) +
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth In",
          "Earth Out",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
barGraph
```

## Looking Specifically at Uptake Only 
First I changed the plot maker to not include fossil fuels in the labeller

```{r changedWithoutFFiplot}
earth_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""
  
  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
      results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
      results
    ylabel <- "Source Amount (Pg C)"
  }
  
  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")
  
  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start),
              subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Earth Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  
  return(areaGraph)
}
```

Then I created a new function that would filter out the fossil fuel emissions, so
it would only show uptake
```{r uptakeOnlyFunc}
split_earth_uptake <- function(ini_file, start, stop, scenario) {
  results <- ffi_results(ini_file, start, stop, scenario)
  results %>% 
    filter(source_name != "fossil_fuels")->
    results
  plot <- earth_plot_maker(results, start, "amount", scenario, FALSE)
  return(plot)
}
```

I also changed the combined dataset in order for it to also be only uptake
```{r filterSplitResults}
total_results_split %>%
  filter(source_name != "fossil_fuels")->
  total_results_split
```

### Uptake Earth Plots {.tabset}
#### RCP 2.6 SSP1
```{r earth_splitNoFFi26s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth_uptake(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earth_splitNoFFi26s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth_uptake(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earth_splitNoFFi19s1, echo=FALSE, message=FALSE, warning=FALSE}
split_earth_uptake(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earth_splitNoFFi19s5, echo=FALSE, message=FALSE, warning=FALSE}
split_earth_uptake(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

#### Facetted
```{r earth_splitNoFFi_facetted, echo=FALSE, message=FALSE, warning=FALSE}
earth_plot_maker(total_results_split, 2020, "amount", "NA", TRUE)
```

### Stacked Bar Chart
I also made stacked bar charts from the combined dataset 

First we needed to filter for years
```{r filterEarthYears2}
total_results_split %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

Then it could be plotted. 
```{r earthStackedBar2, fig.width=9}
barGraph <- ggplot(barData) +
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth In",
          "Earth Out",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
barGraph
```

### Fraction Plots
Then I wanted to look at the fraction of uptake in each plot 

First I wanted to create a set without any earth carbon
```{r Fraction Plots}
total_results_split %>%
  filter(source_name != "earth_c") ->
  no_earth
```

Then I wanted to find the fraction of each of the origin pools of the total
uptake
```{r finding fraction}
total_results_split %>%
  group_by(year, scenario)%>%
  mutate(sum = sum(source_amount))->
  uptake_fraction 

uptake_fraction %>%
  mutate(source_fraction = source_amount/sum)->
  uptake_fraction

no_earth %>%
  group_by(year, scenario)%>%
  mutate(sum = sum(source_amount))->
  uptake_fraction_no_earth

uptake_fraction_no_earth %>%
  mutate(source_fraction = source_amount/sum)->
  uptake_fraction_no_earth
```

#### Fraction Plots {.tabset}
##### RCP 2.6 SSP1
```{r earth_frac_26s1, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction %>%
  filter(scenario == "SSP1 \nRCP 2.6")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 2.6", FALSE)
```

##### RCP 2.6 SSP5
```{r earth_frac_26s5, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction %>%
  filter(scenario == "SSP5 \nRCP 2.6")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP5 \nRCP 2.6", FALSE)
```

##### RCP 1.9 SSP1
```{r earth_frac_19s1, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction %>%
  filter(scenario == "SSP1 \nRCP 1.9")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 1.9", FALSE)
```

##### RCP 1.9 SSP5
```{r earth_frac_19s5, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction %>%
  filter(scenario == "SSP1 \nRCP 1.9")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 1.9", FALSE)
```

##### Faceted
```{r earthFrac_faceted}
earth_plot_maker(uptake_fraction, 2020, "fraction", "Fraction of Uptake", TRUE)
```

#### Fraction Plots (Without Earth Pool) {.tabset}
##### RCP 2.6 SSP1
```{r frac_no_earth_26s1, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction_no_earth %>%
  filter(scenario == "SSP1 \nRCP 2.6")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 2.6", FALSE)
```

##### RCP 2.6 SSP5
```{r frac_no_earth_26s5, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction_no_earth %>%
  filter(scenario == "SSP5 \nRCP 2.6")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP5 \nRCP 2.6", FALSE)
```

##### RCP 1.9 SSP1
```{r frac_no_earth_19s1, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction_no_earth %>%
  filter(scenario == "SSP1 \nRCP 1.9")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 1.9", FALSE)
```

##### RCP 1.9 SSP5
```{r frac_no_earth_19s5, echo=FALSE, message=FALSE, warning=FALSE}
uptake_fraction_no_earth %>%
  filter(scenario == "SSP1 \nRCP 1.9")->
  filtered_frac
earth_plot_maker(filtered_frac, 2020, "fraction", "SSP1 \nRCP 1.9", FALSE)
```

##### Faceted
```{r fracNoEarth_faceted, warning=FALSE}
earth_plot_maker(uptake_fraction_no_earth, 2020, "fraction", "Fraction of Uptake", TRUE)
```


#### Bar Charts {.tabset}
##### With Earth
```{r earthUptakeBarFrac, fig.width=9}
uptake_fraction %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
  barResults

amountBar <- ggplot(barResults)+
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c",
      "HL",
      "intermediate",
      "LL",
      "deep"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere",
      "High Level Ocean",
      "Intermediate Ocean",
      "Low Level Ocean",
      "Deep Ocean"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD",
      "#882255",
      "#AA4499",
      "#88CCEE",
      "#332288"
    )
  )+
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

##### Without Earth
```{r noEarthUptakeBarFrac, fig.width=9}
uptake_fraction_no_earth %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
  barResults

amountBar <- ggplot(barResults)+
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c",
      "HL",
      "intermediate",
      "LL",
      "deep"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere",
      "High Level Ocean",
      "Intermediate Ocean",
      "Low Level Ocean",
      "Deep Ocean"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD",
      "#882255",
      "#AA4499",
      "#88CCEE",
      "#332288"
    )
  )+
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

## Function for increase in each pool
For further examination of the tracking, I decided to look at the rates 
at which each of the pools were changing. I calculated this by looking
at the increase or decrease from the previous year

First I made a fucntion to calcualte the value
```{r diffFunc}
# Tracking plot Function
difference_calc <- function(ini_file, start, stop, title) {
  td <- tracking_results(ini_file, start, stop, title)
  
  td %>%
    group_by(pool_name, source_name) %>%
    mutate(differ = source_amount - lag(source_amount)) ->
  td
  
  # Filtering out years and NA
  td %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    filter(!is.na(differ)) %>%
    filter(differ != 0)->
    td
}
```

Then I created a function to create a plot that displays this difference 
in an area graph. 
```{r diffPlotMaker}
difference_plot_maker <- function(td, pool, title, facet) {
  # Creating better labels
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))

  # A plot of all pools
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
    lineSize <- 1.75
  }
  else {
    lineSize <- 1
  }
  
  lineGraph <- ggplot(td) +
    aes(x = year, y = differ, color = source_name) +
    geom_line(size = lineSize) +
    facet_wrap(~pool_namef,
      scales = "free_y",
      labeller = labeller(pool_namef = c(
        "detritus_c_global" = "Detritus",
        "veg_c_global" = "Vegetation",
        "soil_c_global" = "Soil",
        "earth_c" = "Earth",
        "atmos_c" = "Atmosphere",
        "HL" = "High Level Ocean",
        "intermediate" = "Intermediate Ocean",
        "LL" = "Low Level Ocean",
        "deep" = "Deep Ocean"
      ))
    ) +
    scale_color_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
    ) +
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab("Change from Previous Year (Pg C/Yr)") +
    xlab("Year")
  
  if (facet == FALSE) {
    lineGraph <- lineGraph +
      ggtitle(title)
  } else {
    lineGraph <- lineGraph  +
      facet_wrap(~scenario)
  }
  return(lineGraph)
}
```

I also created a function that combines the previous two into one for ease of use
```{r diffCombinedFunc}
difference_plot <- function(ini_file, start, stop, pool, title){
  td <- difference_calc(ini_file, start, stop, title)
  graph <- difference_plot_maker(td, pool, title, FALSE)
  return(graph)
}
```

I combined all the scenarios into one dataset for faceting
```{r diffCombined}
total_results <-
  rbind(
    difference_calc(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
    difference_calc(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
    difference_calc(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
    difference_calc(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9 ")
  )
```

### Difference Plots {.tabset}
#### RCP 2.6 SSP1
```{r dif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "all", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r dif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "all", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r dif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "all", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r dif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "all", "RCP 1.9 SSP5")
```

### Difference in Earth Pool {.tabset}
#### RCP 2.6 SSP1
```{r earthDif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "earth_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earthDif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "earth_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earthDif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "earth_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earthDif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "earth_c", "RCP 1.9 SSP5")
```

#### Faceted
```{r earthDifFacet}
difference_plot_maker(total_results, "earth_c", "NA", TRUE)
```

### Difference in Atmospheric Pool {.tabset}
#### RCP 2.6 SSP1
```{r atmosDif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "atmos_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r atmosDif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "atmos_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r atmosDif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "atmos_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r atmosDif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "atmos_c", "RCP 1.9 SSP5")
```

#### Faceted
```{r atmosDifFacet}
difference_plot_maker(total_results, "atmos_c", "NA", TRUE)
```

## Atmopsheric Pool Examination
I then took a deeper look at the atmosphere pool. I took a similar approach as the earth
pool and made a function that would look at net change from 2020. 

```{r atmosFunc}
atmos_results <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario)

  results %>%
    filter(pool_name == "atmos_c") %>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount") %>%
    mutate(detritus_c_global = detritus_c_global - first(detritus_c_global))%>%
    mutate(veg_c_global = veg_c_global - first(veg_c_global))%>%
    mutate(soil_c_global = soil_c_global - first(soil_c_global))%>%
    mutate(earth_c = earth_c - first(earth_c))%>%
    mutate(atmos_c = atmos_c - first(atmos_c))%>%
    mutate(HL = HL - first(HL))%>%
    mutate(intermediate = intermediate - first(intermediate))%>%
    mutate(LL = LL - first(LL))%>%
    mutate(deep = deep - first(deep))%>%
    pivot_longer(5:13, names_to = "source_name", values_to = "source_amount") ->
    results
  return(results)
}
```

I also created a function that would also split the atmosphere with the earth pool
```{r splitAtmosFunc}
atmos_results_split <- function(ini_file, start, stop, scenario) {
  results <- tracking_results(ini_file, start, stop, scenario)
  
  core <- newcore(ini_file)
  run(core)
  
  ffi_emissions <- fetchvars(core, 2020:2100, FFI_EMISSIONS())
  ffi_emissions$value <- cumsum(ffi_emissions$value)
  
  ffi_emissions %>%
    select(value, year) %>%
    rename("fossil_fuels" = value) ->
    ffi_emissions
  
  results %>%
    filter(pool_name == "atmos_c") %>%
    right_join(ffi_emissions) %>%
    select(-pool_value, -source_fraction) %>%
    pivot_wider(names_from = "source_name", values_from = "source_amount") %>%
    mutate(earth_c = earth_c - fossil_fuels) %>%
    mutate(detritus_c_global = detritus_c_global - first(detritus_c_global))%>%
    mutate(veg_c_global = veg_c_global - first(veg_c_global))%>%
    mutate(soil_c_global = soil_c_global - first(soil_c_global))%>%
    mutate(earth_c = earth_c - first(earth_c))%>%
    mutate(atmos_c = atmos_c - first(atmos_c))%>%
    pivot_longer(5:14, names_to = "source_name", values_to = "source_amount") ->
    results
  return(results)
}
```

I then also created a plotting function
```{r atmosPlotFunc}
atmos_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  return(areaGraph)
}
```

I then created combined functions for both the unsplit and split atmospheric 
pools
```{r combinedAtmosFunc}
#Unsplit
atmos_plot <- function(ini_file, start, stop, type, scenario) {
  results <- atmos_results(ini_file, start, stop, scenario)
  plot <- atmos_plot_maker(results, start, type, scenario, FALSE)
  return(plot)
}

#Split
atmos_plot_split <- function(ini_file, start, stop, scenario) {
  results <- atmos_results_split(ini_file, start, stop, scenario)
  plot <- atmos_plot_maker(results, start, "amount", scenario, FALSE)
  return(plot)
}
```

I then created larger combined datasets for faceting
```{r facetDataAtmos, message=FALSE, warning=FALSE}
#Unsplit
atmos_combined <- rbind(
  atmos_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
  atmos_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
  atmos_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
  atmos_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
)

#Split
atmos_combined_split <- rbind(
  atmos_results_split(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
  atmos_results_split(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
  atmos_results_split(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
  atmos_results_split(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
)
```

### Atmospheric Plots {.tabset}

#### RCP 2.6 SSP1
```{r atm_am26s1, echo=FALSE}
atmos_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r atm_am26s5, echo=FALSE}
atmos_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r atm_am19s1, echo=FALSE}
atmos_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r atm_am19s5, echo=FALSE}
atmos_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "RCP 1.9 SSP5"
)
```

#### Faceted 
```{r atm_amfaceted, echo=FALSE}
atmos_plot_maker(
  atmos_combined, 2020, "amount", "NA", TRUE
)
```

### Stacked Bar Graphs {.tabset}

First we needed to filter for years
```{r filteratmYears}
atmos_combined %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

#### Graphs {.tabset}
##### Amount of Carbon
```{r atm_stackedAmount, fig.width=9}
amountBar <- ggplot(barData)+
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
amountBar
```

##### Fraction of Pool
```{r atm_stackedFraction, fig.width=9}
fracBar <- ggplot(barResults) +
  aes(x = scenario, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
fracBar
```

```{r atmosPlotFuncHidden, include=FALSE}
atmos_plot_maker <- function(results, start, type, subtitleName, facet) {
  ylabel <- ""

  if (type == "fraction") {
    results %>%
      rename(yval = source_fraction) ->
    results
    ylabel <- "Source Fraction"
  } else {
    results %>%
      rename(yval = source_amount) ->
    results
    ylabel <- "Source Amount (Pg C)"
  }

  # Plotting in area graph of amount
  areaGraph <- ggplot(results) +
    aes(x = year, y = yval, fill = source_name) +
    geom_area() +
    scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth Carbon going out of Atmosphere",
          "Earth Carbon going into Atmosphere",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab(ylabel) +
    xlab("Year")

  if (facet == FALSE) {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start),
        subtitle = subtitleName
      )
  } else {
    areaGraph <- areaGraph +
      ggtitle(paste("Atmospheric Pool: Net Change from", start)) +
      facet_wrap(~scenario)
  }
  return(areaGraph)
}
```

### Atmospheric Pool with Split Earth {.tabset}
#### RCP 2.6 SSP1
```{r atm_split26s1, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r atm_split26s5, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r atm_split19s1, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r atm_split19s5, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_split(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

#### Facetted
```{r atm_split_facetted, echo=FALSE, message=FALSE, warning=FALSE}
atmos_plot_maker(atmos_combined_split, 2020, "amount", "NA", TRUE)
```

### Stacked Bar Graph with Split Earth
I also made stacked bar charts from the combine dataset 

First we needed to filter for years
```{r filteratmYearsSplit}
atmos_combined_split %>%
  filter(year > 2030) %>%
  filter(year %% 25 == 0) ->
barData
```

Then it could be plotted. 
```{r atmStackedBar, fig.width=9}
barGraph <- ggplot(barData) +
  aes(x = scenario, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) +
  scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "fossil_fuels",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth Carbon going out of Atmosphere",
          "Earth Carbon going into Atmosphere",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#0d2612",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Atmosphere Pool: Net Change from 2020")) +
  xlab("Scenario")
barGraph
```

## Earth Origin Carbon Comparison
First I created a function to calculate the Earth Origin carbon and create a plot


```{r earthOriginFunc}
earth_origin_plot <- function(ini_file, start, stop, type, scenarioName) {
  # Filtering for earth origin c
  td <- tracking_results(ini_file, 2020, 2100, scenarioName)

  td %>%
    filter(source_name == "earth_c") %>%
    filter(pool_name == "deep" |
      pool_name == "soil_c_global") %>%
    select(-source_fraction, -pool_value) ->
  td

  title <- ""
  ytitle <- ""

  if (type == "total") {
    title <- "Total Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"
    
    td <- td %>%
      rename(yval = source_amount)
  } else {
    title <- "Total Uptake of Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"

    
    earthData <- ffi_results(ini_file, 2020, 2100, scenarioName)
    earthData %>%
      filter(source_name=="earth_c")%>%
      select(source_amount, year)%>%
      rename(earth_c = "source_amount")->
    earthData
    
    td %>%
      pivot_wider(names_from = "pool_name", values_from = "source_amount") %>%
      right_join(earthData)%>%
      mutate(deep = deep - first(deep)) %>%
      mutate(soil_c_global = soil_c_global - first(soil_c_global)) %>%
      pivot_longer(5:7, names_to = "pool_name", values_to = "source_amount") ->
      td
    
    if (type == "rate") {
      td %>%
        group_by(pool_name, source_name) %>%
        mutate(differ = source_amount - lag(source_amount)) %>%
        filter(!is.na(differ)) ->
      td
      
      title <- "Rate of Uptake of Carbon with Earth Pool Origin"
      ytitle <- "Source Amount (Pg C/Yr)"
      td <- td %>%
        rename(yval = differ)
    }
    else {
      td <- td %>%
        rename(yval = source_amount)
    }
  }


  graph <- ggplot(td) +
    aes(x = year, y = yval, color = pool_name) +
    geom_line(size = 1.25) +
    scale_color_manual(
      limits = c(
        "earth_c",
        "soil_c_global",
        "deep"
      ),
      labels = c(
        "Earth",
        "Soil",
        "Deep Ocean"
      ),
      values = c(
        "#117733",
        "#44AA99",
        "#332288"
      )
    ) +
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab(ytitle) +
    ggtitle(title, 
            subtitle = scenarioName) +
    xlab("Year")
  return(graph)
}
```

### Plots of Total Uptake {.tabset}
#### RCP 2.6 SSP1
```{r earthUptake_26s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP1, 2020, 2100, "uptake", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earthUptake_26s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP5, 2020, 2100, "uptake", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earthUptake_19s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP1, 2020, 2100, "uptake", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earthUptake_19s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP5, 2020, 2100, "uptake", "RCP 1.9 SSP5")
```

### Plots of Rate of Uptake {.tabset}
#### RCP 2.6 SSP1
```{r earthRate_26s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP1, 2020, 2100, "rate", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earthRate_26s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP5, 2020, 2100, "rate", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earthRate_19s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP1, 2020, 2100, "rate", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earthRate_19s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP5, 2020, 2100, "rate", "RCP 1.9 SSP5")
```


### Combining Oceans
Then I combined all layers of the ocean together, as opposed to looking just at 
deep ocean.

I redefined the function to add this calculation.
```{r FulloceanEarthCFunc}
earth_origin_plot <- function(ini_file, start, stop, type, scenarioName) {
  # Filtering for earth origin c
  td <- tracking_results(ini_file, 2020, 2100, scenarioName)

  td %>%
    filter(source_name == "earth_c") %>%
    filter(pool_name == "soil_c_global" |
      pool_name == "deep" |
      pool_name == "HL" |
      pool_name == "intermediate" |
      pool_name == "LL") %>%
    select(-source_fraction, -pool_value) %>%
    pivot_wider(names_from = "pool_name", values_from = "source_amount") %>%
    mutate(ocean = deep + HL + intermediate + LL) %>%
    select(-deep, -HL, -intermediate, -LL) %>%
    pivot_longer(5:6, names_to = "pool_name", values_to = "source_amount") ->
  td

  title <- ""
  ytitle <- ""

  if (type == "total") {
    title <- "Total Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"

    td <- td %>%
      rename(yval = source_amount)
  } else {
    title <- "Total Uptake Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"

    earthData <- ffi_results(ini_file, 2020, 2100, scenarioName)
    earthData %>%
      filter(source_name=="earth_c")%>%
      select(source_amount, year)%>%
      rename(earth_c = "source_amount")->
    earthData
    
    td %>%
      pivot_wider(names_from = "pool_name", values_from = "source_amount") %>%
      right_join(earthData)%>%
      mutate(ocean = ocean - first(ocean)) %>%
      mutate(soil_c_global = soil_c_global - first(soil_c_global)) %>%
      pivot_longer(5:7, names_to = "pool_name", values_to = "source_amount") ->
    td

    if (type == "rate") {
      td %>%
        group_by(pool_name, source_name) %>%
        mutate(differ = source_amount - lag(source_amount)) %>%
        filter(!is.na(differ)) ->
      td

      title <- "Rate of Uptake of Carbon with Earth Pool Origin"
      ytitle <- "Source Amount (Pg C/Yr)"
      td <- td %>%
        rename(yval = differ)
    } else {
      td <- td %>%
        rename(yval = source_amount)
    }
  }


  graph <- ggplot(td) +
    aes(x = year, y = yval, color = pool_name) +
    geom_line(size = 1.25) +
    scale_color_manual(
      limits = c(
        "earth_c",
        "soil_c_global",
        "ocean"
      ),
      labels = c(
        "Earth",
        "Soil",
        "Ocean"
      ),
      values = c(
        "#117733",
        "#44AA99",
        "#332288"
      )
    ) +
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab(ytitle) +
    ggtitle(title,
      subtitle = scenarioName
    ) +
    xlab("Year")
  return(graph)
}
```

### Plots of Total Uptake {.tabset}
#### RCP 2.6 SSP1
```{r fullOcean_earthUptake_26s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP1, 2020, 2100, "uptake", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r fullOcean_earthUptake_26s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP5, 2020, 2100, "uptake", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r fullOcean_earthUptake_19s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP1, 2020, 2100, "uptake", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r fullOcean_earthUptake_19s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP5, 2020, 2100, "uptake", "RCP 1.9 SSP5")
```

### Plots of Rate of Uptake {.tabset}
#### RCP 2.6 SSP1
```{r fullOcean_earthRate_26s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP1, 2020, 2100, "rate", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r fullOcean_earthRate_26s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_26_SSP5, 2020, 2100, "rate", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r fullOcean_earthRate_19s1, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP1, 2020, 2100, "rate", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r fullOcean_earthRate_19s5, echo=FALSE, message=FALSE, warning=FALSE}
earth_origin_plot(ini_file_19_SSP5, 2020, 2100, "rate", "RCP 1.9 SSP5")
```

### Combining into one graph
I then created a new function to combine all the different pathways into one graph

```{r combinedEarthPoolOrigin}
earth_origin_plot_total <- function(td, type) {
  td %>%
    filter(source_name == "earth_c") %>%
    filter(pool_name == "soil_c_global" |
             pool_name == "deep" |
             pool_name == "HL" |
             pool_name == "intermediate" |
             pool_name == "LL") %>%
    select(-source_fraction, -pool_value) %>%
    pivot_wider(names_from = "pool_name", values_from = "source_amount") %>%
    mutate(ocean = deep + HL + intermediate + LL) %>%
    select(-deep, -HL, -intermediate, -LL) %>%
    pivot_longer(5:6, names_to = "pool_name", values_to = "source_amount") ->
    td
  
  title <- ""
  ytitle <- ""
  
  if (type == "total") {
    title <- "Total Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"
    
    td <- td %>%
      rename(yval = source_amount)
  } else {
    title <- "Total Uptake Carbon with Earth Pool Origin"
    ytitle <- "Source Amount (Pg C)"
    
    earthData <- rbind (
      ffi_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
      ffi_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
      ffi_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
      ffi_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
    )
    
    earthData %>%
      filter(source_name=="earth_c")%>%
      select(source_amount, year, scenario)%>%
      rename(earth_c = "source_amount")->
    earthData
    
    td %>%
      pivot_wider(names_from = "pool_name", values_from = "source_amount") %>%
      right_join(earthData)%>%
      group_by(scenario)%>%
      mutate(ocean = ocean - first(ocean)) %>%
      mutate(soil_c_global = soil_c_global - first(soil_c_global)) %>%
      pivot_longer(5:7, names_to = "pool_name", values_to = "source_amount") ->
    td
    
    if (type == "rate") {
      td %>%
        group_by(pool_name, source_name, scenario) %>%
        mutate(differ = source_amount - lag(source_amount)) %>%
        filter(!is.na(differ)) ->
        td
      
      title <- "Rate of Uptake of Carbon with Earth Pool Origin"
      ytitle <- "Source Amount (Pg C/Yr)"
      td <- td %>%
        rename(yval = differ)
    } else {
      td <- td %>%
        rename(yval = source_amount)
    }
  }
  
  
  graph <- ggplot(td) +
    aes(x = year, y = yval, color = pool_name, linetype = scenario) +
    geom_line(size = 0.8) +
    scale_color_manual(
      limits = c(
        "earth_c",
        "soil_c_global",
        "ocean"
      ),
      labels = c(
        "Earth",
        "Soil",
        "Ocean"
      ),
      values = c(
        "#117733",
        "#44AA99",
        "#332288"
      )
    ) +
    scale_linetype_manual(values=c("solid", "longdash", "dotted","dotdash"))+
    guides(color = guide_legend(title = "Carbon Pools")) +
    ylab(ytitle) +
    ggtitle(title) +
    xlab("Year")
  return(graph)
}
```

I then created a combined data set of the tracking results
```{r combinedSimpleTracking}
tracking_data <- rbind(
  tracking_results(ini_file_26_SSP1, 2020, 2100, "SSP1 \nRCP 2.6"),
  tracking_results(ini_file_26_SSP5, 2020, 2100, "SSP5 \nRCP 2.6"),
  tracking_results(ini_file_19_SSP1, 2020, 2100, "SSP1 \nRCP 1.9"),
  tracking_results(ini_file_19_SSP5, 2020, 2100, "SSP5 \nRCP 1.9")
)
```

#### Combined Uptake Plot
```{r combinedUptakeLinetype, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6}
earth_origin_plot_total(tracking_data, "uptake")
```


#### Combined Rate PLot
```{r combinedRateLinetype, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6}
earth_origin_plot_total(tracking_data, "rate")
```

## Airborne Fraction 
First I created  a function to calcualte airborne fraction over a period of 
specified time

```{r airborneFunc}
AF_calc <- function(td, start, stop) {
  
  atm_c <- td %>%
    filter(year == start | year == stop) %>%
    filter(pool_name == "atmos_c") %>%
    filter(source_name == "earth_c")


  atm_c <- last(atm_c$source_amount) - first(atm_c$source_amount)

  earth_c_loss <- td %>%
    filter(year == start | year == stop) %>%
    filter(pool_name == "earth_c") %>%
    filter(source_name == "earth_c")

  earth_c_loss <- first(earth_c_loss$source_amount) - last(earth_c_loss$source_amount)

  AF <- atm_c / earth_c_loss
  
  return(AF)
}
```

Then I calculated the Airborne Fraction for a range of different start years and
end year of 2020 and averaged them 
```{r airborneRange}
rcp26 <- system.file("input", "hector_rcp26.ini", package = "hector")
td <- tracking_results(rcp26, 1800, 2050, "RCP 2.6")

AF_values <- c()
for(val in 1800:1950){
  AF_values <- append(AF_values, AF_calc(td, val, 2000))
}

meanAF <- mean(AF_values)
```

Then I created a simple bar chart comparing to the Knorr 2009 values 
```{r airborne graph}
names <- c("KNORR 1","KNORR 2","KNORR 3","KNORR 4","KNORR 5","KNORR 6","KNORR 7","HECTOR 2.6")
values <- c(0.45, 0.453, 0.518, 0.468, 0.468, 0.514, 0.449, meanAF)
error <- c(0.022, 0.014, 0.064, 0.047, 0.051, 0.035, 0.014, 0)
df <- data.frame(names, values, error)

graph <- ggplot(df) +
  aes(x=names, y=values) + 
  geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=values-error, ymax=values+error), width=.2)+
  ggtitle("Airborne Fraction Comparison")+
  ylab("Airborne Fraction in 2020")+
  xlab(NULL)

graph
```

##### Session Info: 
```{r sessionInfo, echo=FALSE}
sessionInfo()
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>

