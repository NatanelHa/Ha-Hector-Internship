---
title: "Tracking Negative Emissions"
author: "Natanel Ha"
date: "8/4/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: 
     collapsed: false
     smooth_scroll: true
    theme: paper
---

This document reflects done the work done by Natanel Ha on tracking negative
emissions scenarios (constructed with Jay Fuhrman's data) using the simple
climate model Hector's tracking feature. 

### Importing Libraries 
```{r importing, message=FALSE, warning=FALSE, class.source = 'fold-show'}
library(hector)
library(ggplot2)
library(dplyr)
library(tidyr)
```

### Establishing INI files
In all the INI files, the year tracking starts is 2020. I chose this year
because in all the scenarios DACCS starts in 2021, and 2020 seemed 
like a reasonable baseline. 

I chose 4 our of the 8 scenarios to focus on. SSP1 was chosen as a baseline 
run, and SSP5 had the most negative emissions through DACCS so I chose those 
two.
```{r inifiles, message=FALSE, warning=FALSE, class.source = 'fold-show'}
path <- "/Users/Natanel Ha/Documents/GitHub/Ha-Hector-Internship/New Scenarios/"
ini_file_26_SSP1 <- paste(path, "jay_SSP1.ini", sep = "")
ini_file_19_SSP1 <- paste(path, "jay_19_SSP1.ini", sep = "")
ini_file_26_SSP5 <- paste(path, "jay_SSP5.ini", sep = "")
ini_file_19_SSP5 <- paste(path, "jay_19_SSP5.ini", sep = "")
```


## Basic Tracking Plots
Creating basic plots that display the tracking results, in terms of the
fraction of carbon that originated in each pool and the amount of carbon
that originated in each pool. 
```{r basicTrackingFunction}
# tracking plot function
tracking_plot <- function(ini_file, start, stop, graph_type, pool, title) {
  # establish core
  core <- newcore(ini_file)

  # run core
  run(core)

  # Get Results
  results_with_diff <- get_tracking_data(core)
  results_with_diff

  # Filter out diff and year
  td <-
    results_with_diff %>%
    filter(pool_name != "Diff") %>%
    filter(year <= stop) %>%
    filter(year >= start) %>%
    mutate(source_amount = source_fraction * pool_value)

  # Changing Order
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))


  # Set Theme
  theme_set(theme_minimal())

  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
  }

  # Graph of Fractional Portion
  if (graph_type == "fraction") {
    areaGraph <- ggplot(td) +
      aes(x = year, y = source_fraction, fill = source_name) +
      geom_area() +
      facet_wrap(~pool_namef,
        labeller = labeller(pool_namef = c(
          "detritus_c_global" = "Detritus",
          "veg_c_global" = "Vegetation",
          "soil_c_global" = "Soil",
          "earth_c" = "Earth",
          "atmos_c" = "Atmosphere",
          "HL" = "High Level Ocean",
          "intermediate" = "Intermediate Ocean",
          "LL" = "Low Level Ocean",
          "deep" = "Deep Ocean"
        ))
      ) +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
         "Vegetation",
        "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
      ) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab("Source Fraction") +
      ggtitle(title) +
      xlab("Year")

    # Graph of the Amount of Carbon
  } else {
    areaGraph <- ggplot(td) +
      aes(x = year, y = source_amount, fill = source_name) +
      geom_bar(stat = "identity") +
      facet_wrap(~pool_namef,
        scales = "free_y",
        labeller = labeller(pool_namef = c(
          "detritus_c_global" = "Detritus",
          "veg_c_global" = "Vegetation",
          "soil_c_global" = "Soil",
          "earth_c" = "Earth",
          "atmos_c" = "Atmosphere",
          "HL" = "High Level Ocean",
          "intermediate" = "Intermediate Ocean",
          "LL" = "Low Level Ocean",
          "deep" = "Deep Ocean"
        ))
      ) +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c",
          "HL",
          "intermediate",
          "LL",
          "deep"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere",
          "High Level Ocean",
          "Intermediate Ocean",
          "Low Level Ocean",
          "Deep Ocean"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD",
          "#882255",
          "#AA4499",
          "#88CCEE",
          "#332288"
        )
      ) +
      geom_col(width = 1) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab("Source Amount (Pg C)") +
      ggtitle(title) +
      xlab("Year")
  }

  # Shutdown Core
  shutdown(core)

  areaGraph
}
```

### Basic Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r frac26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r frac26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r frac19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r frac19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "all", "RCP 1.9 SSP5"
)
```

### Basic Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r am26s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r am26s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "all", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r am19s1, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r am19s5, echo=FALSE, fig.width=10, fig.height=6}
tracking_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "all", "RCP 1.9 SSP5"
)
```


## Earth Pool Examination 
In order to see where the Negative Emissions were being pulled from, I examined
the Earth Pool in further detail. Since the Earth pool was so large and it was 
hard to see what other pools were inside it, I decided to look at net
change from 2020. 
```{r earthFunc}
earth_plot <- function(ini_file, start, stop, type, scenario) {
  # Establish core
  core <- newcore(ini_file, suppresslogging = TRUE)

  # Run core
  run(core)

  # Get Results
  results <- get_tracking_data(core)

  # Calculating source anount
  results %>%
    filter(pool_name == "earth_c") %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    mutate(source_amount = source_fraction * pool_value) ->
  results

  # Finding earth_c values in start
  # The year negative emissions starts
  earth_start <-
    results %>%
    filter(source_name == "earth_c")

  earth_start_carbon <-
    first(earth_start$source_amount)

  earth_start_fraction <-
    first(earth_start$source_fraction)

  # Calculating difference from start
  results %>%
    mutate(source_amount = source_amount - earth_start_carbon * (source_name == "earth_c")) %>%
    mutate(source_fraction = source_fraction - earth_start_fraction * (source_name == "earth_c")) ->
  results

  if (type == "amount") {
    # Plotting in area graph of amount
    areaGraph <- ggplot(results) +
      aes(x = year, y = source_amount, fill = source_name) +
      geom_area() +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD"
        )
      ) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab("Source Amount (Pg C)") +
      ggtitle(paste("Earth Pool: Net Change from", start), 
              subtitle = scenario) +
      xlab("Year")
    return(areaGraph)
  } else {
    # Plotting in area graph of fraction
    areaGraph2 <- ggplot(results) +
      aes(x = year, y = source_fraction, fill = source_name) +
      geom_area() +
      scale_fill_manual(
        limits = c(
          "detritus_c_global",
          "veg_c_global",
          "soil_c_global",
          "earth_c",
          "atmos_c"
        ),
        labels = c(
          "Detritus",
          "Vegetation",
          "Soil",
          "Earth",
          "Atmosphere"
        ),
        values = c(
          "#DDCC77",
          "#999933",
          "#44AA99",
          "#117733",
          "#DDDDDD"
        )
      ) +
      guides(fill = guide_legend(title = "Carbon Pools")) +
      ylab("Source Fraction") +
      ggtitle(paste("Earth Pool: Net Change from", start), 
              subtitle = scenario) +
      xlab("Year")
    return(areaGraph2)
  }
}
```

### Earth Fraction Plots {.tabset}

#### RCP 2.6 SSP1
```{r earth_frac26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "fraction", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_frac26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "fraction", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_frac19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "fraction", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_frac19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "fraction", "RCP 1.9 SSP5"
)
```

### Earth Plots of Amounts of Carbon {.tabset}

#### RCP 2.6 SSP1
```{r earth_am26s1, echo=FALSE}
earth_plot(
  ini_file_26_SSP1, 2020, 2100,
  "amount", "RCP 2.6 SSP1"
)
```


#### RCP 2.6 SSP5
```{r earth_am26s5, echo=FALSE}
earth_plot(
  ini_file_26_SSP5, 2020, 2100,
  "amount", "RCP 2.6 SSP5"
)
```

#### RCP 1.9 SSP1
```{r earth_am19s1, echo=FALSE}
earth_plot(
  ini_file_19_SSP1, 2020, 2100,
  "amount", "RCP 1.9 SSP1"
)
```

#### RCP 1.9 SSP5
```{r earth_am19s5, echo=FALSE}
earth_plot(
  ini_file_19_SSP5, 2020, 2100,
  "amount", "RCP 1.9 SSP5"
)
```


## Split Earth Pool
Splitting Earth pool with fossil fuel emissions to take account for the 
earth pool going in vs the earth pool going out

```{r ffi}
ffi_results <- function(ini_file, start, stop, scenario) {
  # Establish core
  core <- newcore(ini_file, suppresslogging = TRUE)
  
  # Run core
  run(core)
  
  # Get Results
  results <- get_tracking_data(core)
  
  # Calculating source anount
  results %>%
    filter(pool_name == "earth_c") %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    mutate(source_amount = source_fraction * pool_value) ->
    results
  
  #Get ffi emissions
  ffi_emissions <- fetchvars(core, 2020:2100, FFI_EMISSIONS())
  ffi_emissions$value<-cumsum(ffi_emissions$value)
  
  # The year negative emissions starts
  earth_start <-
    results %>%
    filter(source_name == "earth_c")
  
  earth_start_carbon <-
    first(earth_start$source_amount)
  
  earth_start_fraction <-
    first(earth_start$source_fraction)
  
  # Calculating difference from start
  results %>%
    mutate(source_amount = source_amount - earth_start_carbon * (source_name == "earth_c")) %>%
    mutate(source_fraction = source_fraction - earth_start_fraction * (source_name == "earth_c")) ->
    results
  
  ffi_emissions %>%
    select(value, year)%>%
    rename("fossil_fuels" = value)->
    ffi_emissions
  
  results %>%
    right_join(ffi_emissions)%>%
    select(-pool_value, -source_fraction)%>%
    pivot_wider(names_from="source_name", values_from="source_amount")%>%
    mutate(earth_c = earth_c + fossil_fuels) %>%
    mutate(fossil_fuels = fossil_fuels*-1) %>%
    pivot_longer(4:13, names_to = "source_name", values_to = "source_amount")->
  results

  areaGraph <- ggplot(results) +
    aes(x = year, y = source_amount, fill = source_name) +
    geom_area() +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "fossil_fuels",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth In",
        "Earth Out",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#882255",
        "#DDDDDD"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab("Source Amount (Pg C)") +
    ggtitle(paste("Earth Pool: Net Change from 2020"), 
            subtitle = scenario) +
    xlab("Year")
  return(areaGraph)
}
```

### Split Earth Plots {.tabset}
#### RCP 2.6 SSP1
```{r earth_split26s1, echo=FALSE, message=FALSE, warning=FALSE}
ffi_results(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP6
```{r earth_split26s5, echo=FALSE, message=FALSE, warning=FALSE}
ffi_results(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earth_split19s1, echo=FALSE, message=FALSE, warning=FALSE}
ffi_results(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earth_split19s5, echo=FALSE, message=FALSE, warning=FALSE}
ffi_results(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
```

## Function for increase in each pool
For further examination of the tracking, I decided to look at the rates 
at which each of the pools were changing. I calculated this by looking
at the increase or decrease from the previous year
```{r diffFunc}
# Tracking plot Function
difference_plot <- function(ini_file, start, stop, pool, title) {
  core <- newcore(ini_file, suppresslogging = TRUE)

  # run core
  run(core)

  # Get td
  td <- get_tracking_data(core)

  # Calculating Source amount and Diff
  td %>%
    filter(pool_name != "Diff") %>%
    mutate(source_amount = source_fraction * pool_value) %>%
    group_by(pool_name, source_name) %>%
    mutate(differ = source_amount - lag(source_amount)) ->
  td

  # Creating better labels
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))

  # Filtering out years and NA
  td %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    filter(!is.na(differ)) ->
  td

  # A plot of all pools
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
  }
  areaGraph <- ggplot(td) +
    aes(x = year, y = differ, fill = source_name) +
    geom_area() +
    facet_wrap(~pool_namef,
      scales = "free_y",
      labeller = labeller(pool_namef = c(
        "detritus_c_global" = "Detritus",
        "veg_c_global" = "Vegetation",
        "soil_c_global" = "Soil",
        "earth_c" = "Earth",
        "atmos_c" = "Atmosphere",
        "HL" = "High Level Ocean",
        "intermediate" = "Intermediate Ocean",
        "LL" = "Low Level Ocean",
        "deep" = "Deep Ocean"
      ))
    ) +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c",
        "HL",
        "intermediate",
        "LL",
        "deep"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere",
        "High Level Ocean",
        "Intermediate Ocean",
        "Low Level Ocean",
        "Deep Ocean"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD",
        "#882255",
        "#AA4499",
        "#88CCEE",
        "#332288"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab("Change from Previous Year (Pg C/Yr)") +
    ggtitle(title) +
    xlab("Year")

  areaGraph
}
```

```{r diffFunc2, include=FALSE}
# Tracking plot Function
difference_plot2 <- function(ini_file, start, stop, pool, title) {
  core <- newcore(ini_file, suppresslogging = TRUE)

  # run core
  run(core)

  # Get td
  td <- get_tracking_data(core)

  # Calculating Source amount and Diff
  td %>%
    filter(pool_name != "Diff") %>%
    mutate(source_amount = source_fraction * pool_value) %>%
    group_by(pool_name, source_name) %>%
    mutate(differ = source_amount - lag(source_amount)) ->
  td

  # Creating better labels
  td$pool_namef <- factor(td$pool_name, levels = c(
    "detritus_c_global",
    "veg_c_global",
    "soil_c_global",
    "earth_c",
    "atmos_c",
    "HL",
    "intermediate",
    "LL",
    "deep"
  ))

  # Filtering out years and NA
  td %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    filter(!is.na(differ)) ->
  td

  # A plot of all pools
  if (pool != "all") {
    td %>%
      filter(pool_name == pool) ->
    td
  }
  areaGraph <- ggplot(td) +
    aes(x = year, y = differ, fill = source_name) +
    geom_area() +
    facet_wrap(~pool_namef,
      scales = "free_y",
      labeller = labeller(pool_namef = c(
        "detritus_c_global" = "Detritus",
        "veg_c_global" = "Vegetation",
        "soil_c_global" = "Soil",
        "earth_c" = "Earth",
        "atmos_c" = "Atmosphere",
        "HL" = "High Level Ocean",
        "intermediate" = "Intermediate Ocean",
        "LL" = "Low Level Ocean",
        "deep" = "Deep Ocean"
      ))
    ) +
    scale_fill_manual(
      limits = c(
        "detritus_c_global",
        "veg_c_global",
        "soil_c_global",
        "earth_c",
        "atmos_c"
      ),
      labels = c(
        "Detritus",
        "Vegetation",
        "Soil",
        "Earth",
        "Atmosphere"
      ),
      values = c(
        "#DDCC77",
        "#999933",
        "#44AA99",
        "#117733",
        "#DDDDDD"
      )
    ) +
    guides(fill = guide_legend(title = "Carbon Pools")) +
    ylab("Change from Previous Year (Pg C/Yr)") +
    ggtitle(title) +
    xlab("Year")

  areaGraph
}
```

### Difference Plots {.tabset}
#### RCP 2.6 SSP1
```{r dif26s1, echo=FALSE}
difference_plot(ini_file_26_SSP1, 2020, 2100, "all", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r dif26s5, echo=FALSE}
difference_plot(ini_file_26_SSP5, 2020, 2100, "all", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r dif19s1, echo=FALSE}
difference_plot(ini_file_19_SSP1, 2020, 2100, "all", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r dif19s5, echo=FALSE}
difference_plot(ini_file_19_SSP5, 2020, 2100, "all", "RCP 1.9 SSP5")
```

### Difference in Earth Pool {.tabset}
#### RCP 2.6 SSP1
```{r earthDif26s1, echo=FALSE}
difference_plot2(ini_file_26_SSP1, 2020, 2100, "earth_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r earthDif26s5, echo=FALSE}
difference_plot2(ini_file_26_SSP5, 2020, 2100, "earth_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r earthDif19s1, echo=FALSE}
difference_plot2(ini_file_19_SSP1, 2020, 2100, "earth_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r earthDif19s5, echo=FALSE}
difference_plot2(ini_file_19_SSP5, 2020, 2100, "earth_c", "RCP 1.9 SSP5")
```

### Difference in Atmospheric Pool {.tabset}
#### RCP 2.6 SSP1
```{r atmosDif26s1, echo=FALSE}
difference_plot2(ini_file_26_SSP1, 2020, 2100, "atmos_c", "RCP 2.6 SSP1")
```

#### RCP 2.6 SSP5
```{r atmosDif26s5, echo=FALSE}
difference_plot2(ini_file_26_SSP5, 2020, 2100, "atmos_c", "RCP 2.6 SSP5")
```

#### RCP 1.9 SSP1
```{r atmosDif19s1, echo=FALSE}
difference_plot2(ini_file_19_SSP1, 2020, 2100, "atmos_c", "RCP 1.9 SSP1")
```

#### RCP 1.9 SSP5
```{r atmosDif19s5, echo=FALSE}
difference_plot2(ini_file_19_SSP5, 2020, 2100, "atmos_c", "RCP 1.9 SSP5")
```

## Comparing Scenarios
I then got the results and combined them to make faceted graphs and bar plots.
I specifically looked at the Earth Pool. 

```{r compare}
# Function to get results
get_results <- function(ini_file, start, stop, name) {
  # Establish core
  core <- newcore(ini_file, suppresslogging = TRUE)

  # Run core
  run(core)

  # Get Results
  results <- get_tracking_data(core)

  # Calculating source anount
  results %>%
    filter(pool_name == "earth_c") %>%
    filter(year >= start) %>%
    filter(year <= stop) %>%
    mutate(unmod_source_amount = source_fraction * pool_value) ->
  results

  # Finding earth_c values in start
  # The year negative emissions starts
  earth_start <-
    results %>%
    filter(source_name == "earth_c")

  earth_start_carbon <-
    first(earth_start$unmod_source_amount)

  earth_start_fraction <-
    first(earth_start$source_fraction)

  # Calculating difference from start
  results %>%
    mutate(source_amount = unmod_source_amount - earth_start_carbon * (source_name == "earth_c")) %>%
    mutate(source_fraction = source_fraction - earth_start_fraction * (source_name == "earth_c")) %>%
    mutate(scenario = name) %>%
    filter(source_name == "earth_c" | source_name == "detritus_c_global" 
           | source_name == "atmos_c" |source_name == "soil_c_global" 
           | source_name == "veg_c_global")%>%
    group_by(pool_name, source_name) %>%
    mutate(differ = unmod_source_amount - lag(unmod_source_amount)) ->
  results
  return(results)
}

total_results <-
  rbind(
    get_results(ini_file_26_SSP1, 2020, 2100, "RCP 2.6 SSP1"),
    get_results(ini_file_26_SSP5, 2020, 2100, "RCP 2.6 SSP5"),
    get_results(ini_file_19_SSP1, 2020, 2100, "RCP 1.9 SSP1"),
    get_results(ini_file_19_SSP5, 2020, 2100, "RCP 1.9 SSP5")
  )
```

### Faceted Area Graphs {.tabset}
#### Amount of Carbon
```{r facetedAmount}
amount <- ggplot(total_results) +
  aes(x = year, y = source_amount, fill = source_name) +
  geom_area() +
  facet_wrap(~scenario) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Year")
amount
```

#### Fraction of Pool
```{r compareFrac}
frac <- ggplot(total_results) +
  aes(x = year, y = source_fraction, fill = source_name) +
  geom_area() +
  facet_wrap(~scenario) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  xlab("Year")
frac
```

### Bar Graphs
I then created bar graphs for net Change by the end of the century

First I had to filter the results
```{r barFilter}
total_results %>%
  filter(year == 2100) ->
total_results_2100
```

#### Graphs {.tabset}
##### Amount of Carbon
```{r amountBar}
amountBar <- ggplot(total_results_2100) +
  aes(x = source_name, y = source_amount, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~scenario) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Amount (Pg C)") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
amountBar
```

##### Fraction of Pool
```{r fracBar}
fracBar <- ggplot(total_results_2100) +
  aes(x = source_name, y = source_fraction, fill = source_name) +
  geom_bar(stat = "identity") +
  facet_wrap(~scenario) +
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Source Fraction") +
  ggtitle(paste("Earth Pool: Net Change from 2020")) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
fracBar
```

### Difference Comparison
```{r diffComp, message=FALSE, warning=FALSE}
dif <- ggplot(total_results) +
  aes(x = year, y = differ, fill = source_name) +
  geom_area() +
  facet_wrap(~scenario)+
  scale_fill_manual(
    limits = c(
      "detritus_c_global",
      "veg_c_global",
      "soil_c_global",
      "earth_c",
      "atmos_c"
    ),
    labels = c(
      "Detritus",
      "Vegetation",
      "Soil",
      "Earth",
      "Atmosphere"
    ),
    values = c(
      "#DDCC77",
      "#999933",
      "#44AA99",
      "#117733",
      "#DDDDDD"
    )
  ) +
  guides(fill = guide_legend(title = "Carbon Pools")) +
  ylab("Change from Previous Year (Pg C)") +
  ggtitle("Difference in Earth Pool") +
  xlab("Year")
dif
```

### Session Info: 
```{r sessionInfo, echo=FALSE}
sessionInfo()
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>

